name: Integration Tests

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    # Allow manual trigger for testing


permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python_ver: ["3.10", "3.11", "3.12", "3.13"]
    # Only run if comment contains "/ok-to-test" and is on a PR
    # Team membership will be verified for issue_comment events only
    if: |
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '/ok-to-test')) ||
      github.event_name == 'workflow_dispatch'
    steps:
    - name: Simple check to verify user is authorized
      if: github.event_name == 'issue_comment'
      run: |
        username="${{ github.event.comment.user.login }}"
        allowed_users=("sicoyle" "yaron2" "Cyb3rWard0g")
        
        if [[ ! " ${allowed_users[@]} " =~ " ${username} " ]]; then
          echo "User ${username} is not authorized to run this workflow."
          echo "Must be one of: sicoyle, yaron2, Cyb3rWard0g"
          exit 1
        fi
        
        echo "User ${username} is authorized to run this workflow."
    
    - name: Get PR details
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions/github-script@v8
      with:
        script: |
          const pr = context.payload.issue.pull_request;
          if (!pr) {
            core.setFailed('Not a pull request');
            return;
          }
          const { data } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.issue.number,
          });
          core.setOutput('head_sha', data.head.sha);
          core.setOutput('head_ref', data.head.ref);
          core.setOutput('head_repo', data.head.repo.full_name);
    
    - name: Checkout PR
      if: github.event_name == 'issue_comment'
      uses: actions/checkout@v6
      with:
        ref: ${{ steps.pr.outputs.head_sha }}
        repository: ${{ steps.pr.outputs.head_repo }}
    
    - name: Checkout
      if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
      uses: actions/checkout@v6
    
    - name: Set up Python ${{ matrix.python_ver }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python_ver }}
    
    - name: Set up Docker
      uses: docker/setup-docker-action@v4
    
    - name: Install Dapr CLI
      run: |
        wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash
    
    - name: Initialize Dapr
      run: |
        dapr init
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e .
        uv pip install -e ".[test]"

    - name: Free up disk space
      run: |
        echo "=== Disk space before cleanup ==="
        df -h
        sudo apt-get clean || true=
        find quickstarts -type d -name "ephemeral_test_venv" -exec rm -rf {} + 2>/dev/null || true
        echo "=== Disk space after cleanup ==="
        df -h

    - name: Run Integration Tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        uv run pytest -m integration -v tests/integration/quickstarts
        # TODO: In future, run all integration tests in parallel (one file per quickstart directory)
        # -n auto uses all available CPUs, or specify -n 4 for fixed number
        # pytest -m integration -v -n auto tests/integration/quickstarts/

  # Summary job that runs after all matrix jobs complete and comments on PR
  comment-summary:
    needs: integration-tests
    runs-on: ubuntu-latest
    if: always() && needs.integration-tests.result != 'skipped' && github.event_name == 'issue_comment'
    permissions:
      pull-requests: write
      actions: read
    steps:
    - name: Comment PR with test results summary
      uses: actions/github-script@v8
      with:
        script: |
          const prNumber = context.payload.issue.number;
          if (!context.payload.issue.pull_request) {
            core.setFailed('This is not a pull request');
            return;
          }
          const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          // Get all integration test jobs (matrix jobs have names like "integration-tests (3.10)")
          const testJobs = jobs.jobs.filter(job => 
            job.name === 'integration-tests' || job.name.startsWith('integration-tests (')
          );
          
          // Build summary table
          let summary = '## Integration Tests Summary\n\n';
          summary += '| Python Version | Status |\n';
          summary += '|----------------|--------|\n';
          
          let allPassed = true;
          const pythonVersions = ['3.10', '3.11', '3.12', '3.13'];
          
          // Find jobs by Python version
          for (const pythonVer of pythonVersions) {
            // Try to find job by name first (matrix jobs: "integration-tests (3.10)")
            let job = testJobs.find(j => j.name === `integration-tests (${pythonVer})`);
            
            // Fallback: find by Python version in steps
            if (!job) {
              job = testJobs.find(j => 
                j.steps.some(step => step.name && step.name.includes(pythonVer))
              );
            }
            
            // Last fallback: use index
            if (!job && testJobs.length > pythonVersions.indexOf(pythonVer)) {
              job = testJobs[pythonVersions.indexOf(pythonVer)];
            }
            
            if (job) {
              const isSuccess = job.conclusion === 'success';
              const status = isSuccess ? '✅ PASSED' : '❌ FAILED';
              const jobUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/job/${job.id}`;
              summary += `| ${pythonVer} | [${status}](${jobUrl}) |\n`;
              if (!isSuccess) {
                allPassed = false;
              }
            } else {
              // Job not found - mark as failed
              summary += `| ${pythonVer} | ❌ NOT FOUND |\n`;
              allPassed = false;
            }
          }
          
          summary += `\n**Overall Status:** ${allPassed ? '✅ All tests passed' : '❌ Some tests failed'}\n`;
          summary += `**Workflow:** [View run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
          
          // Find existing comment or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const existingComment = comments.find(c => 
            c.user.type === 'Bot' && 
            c.body.includes('## Integration Tests Summary')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: summary,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summary,
            });
          }
          
          // Fail the job if any tests failed
          if (!allPassed) {
            core.setFailed('Integration tests failed');
          }
    